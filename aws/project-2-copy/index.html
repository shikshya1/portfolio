<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Mount AWS EFS volume into AWS Lambda with the Serverless Framework | Shikshya Dahal</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="One of the biggest challenge while deploying machine learning applications in AWS Lambda is the limited size of deployment package. It becomes more challenging when you are dealing with &lsquo;state of art&rsquo; models like BERT. There are several ways to compress the models and use it in production. One of the technique is to mount EFS to the serverless function.
EFS is built to scale on demand to petabytes of data, growing and shrinking automatically as files are written and deleted."><meta name=generator content="Hugo 0.108.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/portfolio/ananke/css/main.min.css><meta property="og:title" content="Mount AWS EFS volume into AWS Lambda with the Serverless Framework "><meta property="og:description" content="One of the biggest challenge while deploying machine learning applications in AWS Lambda is the limited size of deployment package. It becomes more challenging when you are dealing with &lsquo;state of art&rsquo; models like BERT. There are several ways to compress the models and use it in production. One of the technique is to mount EFS to the serverless function.
EFS is built to scale on demand to petabytes of data, growing and shrinking automatically as files are written and deleted."><meta property="og:type" content="article"><meta property="og:url" content="https://shikshya1.github.io/portfolio/aws/project-2-copy/"><meta property="article:section" content="AWS"><meta property="article:published_time" content="2022-10-01T10:58:08-04:00"><meta property="article:modified_time" content="2022-10-01T10:58:08-04:00"><meta property="og:site_name" content="Shikshya Dahal"><meta itemprop=name content="Mount AWS EFS volume into AWS Lambda with the Serverless Framework "><meta itemprop=description content="One of the biggest challenge while deploying machine learning applications in AWS Lambda is the limited size of deployment package. It becomes more challenging when you are dealing with &lsquo;state of art&rsquo; models like BERT. There are several ways to compress the models and use it in production. One of the technique is to mount EFS to the serverless function.
EFS is built to scale on demand to petabytes of data, growing and shrinking automatically as files are written and deleted."><meta itemprop=datePublished content="2022-10-01T10:58:08-04:00"><meta itemprop=dateModified content="2022-10-01T10:58:08-04:00"><meta itemprop=wordCount content="386"><meta itemprop=keywords content="Serverless,AWS Lambda,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mount AWS EFS volume into AWS Lambda with the Serverless Framework "><meta name=twitter:description content="One of the biggest challenge while deploying machine learning applications in AWS Lambda is the limited size of deployment package. It becomes more challenging when you are dealing with &lsquo;state of art&rsquo; models like BERT. There are several ways to compress the models and use it in production. One of the technique is to mount EFS to the serverless function.
EFS is built to scale on demand to petabytes of data, growing and shrinking automatically as files are written and deleted."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://shikshya1.github.io/portfolio/images/cpv.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/portfolio/ class="f3 fw2 hover-white no-underline white-90 dib">Shikshya Dahal</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/aws/ title="AWS page">AWS</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/ml/ title="ML Basics page">ML Basics</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/nlp/ title="NLP page">NLP</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/projects/ title="Projects page">Projects</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/statistics/ title="Statistics page">Statistics</a></li></ul><div class=ananke-socials><a href=https://github.com/shikshya1 target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Mount AWS EFS volume into AWS Lambda with the Serverless Framework</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">AWS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Mount AWS EFS volume into AWS Lambda with the Serverless Framework</h1><time class="f6 mv4 dib tracked" datetime=2022-10-01T10:58:08-04:00>October 1, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>One of the biggest challenge while deploying machine learning applications in AWS Lambda is the limited size of deployment package. It becomes more challenging when you are dealing with &lsquo;state of art&rsquo; models like BERT. There are several ways to compress the models and use it in production. One of the technique is to mount EFS to the serverless function.</p><p>EFS is built to scale on demand to petabytes of data, growing and shrinking automatically as files are written and deleted. When used with Lambda, your code has low-latency access to a file system where data is persisted after the function terminates.</p><p>In this post, I am going to use sentence transformer to re-rank the sentences based on text similarity to a given query.</p><h4 id=creating-an-efs-file-system-and-upload-the-required-libraries-and-models>Creating an EFS file system and upload the required libraries and models</h4><p>The first step is to create an EFS file system. Then we can start an ec2 instance and mount the file system to install the required packages and models on EFS. The instance must have access to the same security group and reside in the same VPC as the EFS file system.</p><h4 id=create-a-lambda-function>Create a lambda function</h4><p>Then, we can create a lambda function using serverless aws-python3 template.</p><p>we first need to initialize the model. paraphrase-MiniLM-L6-v2 is a sentence-transformers model which maps sentences & paragraphs to a 384 dimensional dense vector space and can be used for tasks like clustering or semantic search.</p><pre tabindex=0><code>model = SentenceTransformer(&#39;/mnt/tmp/paraphrase-MiniLM-L6-v2&#39;)
</code></pre><p>We can build sentence embeddings using the encode method.</p><pre tabindex=0><code>embeddings= model.encode(documents)
query_embeddings= model.encode(query)
</code></pre><p>Once, we have the embeddings of both the sentences and query parameter, we can compare the sentence similarity using cosine similarity.</p><pre tabindex=0><code>scores = cos_sim(query_embeddings, embeddings).flatten()
</code></pre><h4 id=configure-serverlessyaml>Configure serverless.yaml</h4><p>Lambda functions that access EFS must also run within the same VPC. We need to provide the arn of the EFS access point and path under which the EFS is moounted in the lambda function.</p><pre tabindex=0><code>fileSystemConfig:
      localMountPath: /mnt/tmp
      arn: arn:aws:elasticfilesystem:us-east-1:931955206531:access-point/fsap-08c6b99eba84f318e
    vpc:
      securityGroupIds:
        - sg-b774b4f9
      subnetIds:
        - subnet-40762e0a
        - subnet-42881d1e
        - subnet-97fc74f0
</code></pre><p>Since we are loading the required python libraries from the EFS, we need to provide python path to our lambda function.</p><pre tabindex=0><code>environment:
   PYTHONPATH: &#34;/mnt/tmp/lib&#34;
</code></pre><h4 id=deploy-and-test-the-function>Deploy and Test the function</h4><p>To test the function, I am using AWS console and the snapshot of the result is attached below.</p><h4 id=references>References:</h4><ol><li><a href=https://aws.amazon.com/blogs/compute/using-amazon-efs-for-aws-lambda-in-your-serverless-applications/>https://aws.amazon.com/blogs/compute/using-amazon-efs-for-aws-lambda-in-your-serverless-applications/</a></li></ol><h3 id=link-to-github-page-codehttpsgithubcomshikshya1aws-serverlesstreemainsentence-similarity-efs>Link to github page: <a href=https://github.com/shikshya1/aws-serverless/tree/main/sentence-similarity-efs>Code</a></h3><ul class=pa0><li class="list di"><a href=/tags/serverless class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Serverless</a></li><li class="list di"><a href=/tags/aws-lambda class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS Lambda</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/portfolio/aws/project-1/>Deploy lambda function with external python packages using serverless framework.</a></li><li class=mb2><a href=/portfolio/aws/project-2/>Create a trigger to upload records from csv to DynamoDB when csv file is inserted on S3 via Lambda function using Serverless Framework</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3"></a><div><div class=ananke-socials><a href=https://github.com/shikshya1 target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>