<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Deploy lambda function with external python packages using serverless framework. | Shikshya Dahal</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Lambda Function & Layers: AWS Lambda is a computing service that allows us to run our code without the overhead of configuring and managing a server. It can be scaled automatically based on the request and the charge is calculated only for the compute time. Lambda function can be deployed using .zip file archive that contains function and the dependency or using container image. Lambda layers can be used to package external dependencies that is required to run lambda function."><meta name=generator content="Hugo 0.108.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/portfolio/ananke/css/main.min.css><meta property="og:title" content="Deploy lambda function with external python packages using serverless framework. "><meta property="og:description" content="Lambda Function & Layers: AWS Lambda is a computing service that allows us to run our code without the overhead of configuring and managing a server. It can be scaled automatically based on the request and the charge is calculated only for the compute time. Lambda function can be deployed using .zip file archive that contains function and the dependency or using container image. Lambda layers can be used to package external dependencies that is required to run lambda function."><meta property="og:type" content="article"><meta property="og:url" content="https://shikshya1.github.io/portfolio/aws/project-1/"><meta property="article:section" content="AWS"><meta property="article:published_time" content="2022-10-01T10:58:08-04:00"><meta property="article:modified_time" content="2022-10-01T10:58:08-04:00"><meta property="og:site_name" content="Shikshya Dahal"><meta itemprop=name content="Deploy lambda function with external python packages using serverless framework. "><meta itemprop=description content="Lambda Function & Layers: AWS Lambda is a computing service that allows us to run our code without the overhead of configuring and managing a server. It can be scaled automatically based on the request and the charge is calculated only for the compute time. Lambda function can be deployed using .zip file archive that contains function and the dependency or using container image. Lambda layers can be used to package external dependencies that is required to run lambda function."><meta itemprop=datePublished content="2022-10-01T10:58:08-04:00"><meta itemprop=dateModified content="2022-10-01T10:58:08-04:00"><meta itemprop=wordCount content="606"><meta itemprop=keywords content="Serverless,AWS Lambda,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploy lambda function with external python packages using serverless framework. "><meta name=twitter:description content="Lambda Function & Layers: AWS Lambda is a computing service that allows us to run our code without the overhead of configuring and managing a server. It can be scaled automatically based on the request and the charge is calculated only for the compute time. Lambda function can be deployed using .zip file archive that contains function and the dependency or using container image. Lambda layers can be used to package external dependencies that is required to run lambda function."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://shikshya1.github.io/portfolio/images/cpv.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/portfolio/ class="f3 fw2 hover-white no-underline white-90 dib">Shikshya Dahal</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/about/ title="About page">About</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/aws/ title="AWS page">AWS</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/ml/ title="ML Basics page">ML Basics</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/nlp/ title="NLP page">NLP</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/projects/ title="Projects page">Projects</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/portfolio/statistics/ title="Statistics page">Statistics</a></li></ul><div class=ananke-socials><a href=https://github.com/shikshya1 target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Deploy lambda function with external python packages using serverless framework.</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">AWS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Deploy lambda function with external python packages using serverless framework.</h1><time class="f6 mv4 dib tracked" datetime=2022-10-01T10:58:08-04:00>October 1, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Lambda Function & Layers: AWS Lambda is a computing service that allows us to run our code without the overhead of configuring and managing a server. It can be scaled automatically based on the request and the charge is calculated only for the compute time. Lambda function can be deployed using .zip file archive that contains function and the dependency or using container image. Lambda layers can be used to package external dependencies that is required to run lambda function. It promotes sharing components that can be used in multiple lambda functions. It also helps in reducing the size of lambda function making it faster to deploy our code.</p><p>We can manually create a lambda layer and add it to the lambda function. Lambda uses Amazon linux environment, so make sure your dependencies will work in that environment. For each Lambda runtime, the PATH variable includes specific folders in the /opt directory. so, we should define the same folder structure in your layer .zip file archive. For python, python and python/lib/python{version}/site-packages are folder paths that runtime supports.</p><p>But serverless framework makes it easier as everything can be defined through the YAML file. Serverless Framework can be used to develop, deploy and troubleshoot serverless applications.</p><p>Installing Serverless Framework:</p><p>Severless Framework requires node. So, if you don&rsquo;t have node on your machine, install it first. After that we can install serverless using:</p><pre tabindex=0><code>npm install -g serverless
</code></pre><p>Set up a user with minimal permissions that is required for your application and configure serverless framework by providing access and secret key from AWS.</p><pre tabindex=0><code>serverless config credentials --provider aws --key &#39;&#39; --secret &#39;&#39; -o
</code></pre><p>Make sure you&rsquo;re using a virtual environment to isolate your python package installation.</p><pre tabindex=0><code>python3 -m venv env
source env/bin/activate
</code></pre><p>Create a serverless function:</p><pre tabindex=0><code>serverless create --template aws-python3 --name lambda-test --path lambda-test
</code></pre><p>or you can choose from the template provided by serverless framework using:</p><pre tabindex=0><code>serverless
</code></pre><p>We can further install serverless-layers so that it attaches layers to the function and publishes a new layer whenever dependencies is updated.</p><pre tabindex=0><code>npm install -D serverless-layers
</code></pre><p>Install plugin:</p><p>To deploy the content of requirements.txt, we need serverless-python-requirements plugin. This plugin bundles python dependencies specified in requirements.txt while running sls deploy. Plugins can be installed using:</p><pre tabindex=0><code>sls plugin install --name pluginName
</code></pre><p>In this case pluginName will be replaced by serverless-python-requirements</p><pre tabindex=0><code>sls plugin install --name serverless-python-requirements
</code></pre><p>Update the handler.py with the code that you want to run and add the python packages that you need to run the code in requirements.txt</p><pre tabindex=0><code>try:
    import unzip_requirements
except:
    pass
    
import json
import pandas as pd

def hello(event, context):

    data = {
        &#34;name&#34;: [&#34;Joe&#34;, &#34;Steve&#34;],
        &#34;Department&#34;: [&#34;Computer&#34;, &#34;Mechanical&#34;]
        }
    
    df= pd.DataFrame(data)
    print(df.head(2))
    return {&#34;statusCode&#34;: 200, 
    &#34;body&#34;: json.dumps(&#39;Demo lambda function to test pandas layer&#39;)}
</code></pre><p>Update the Serverless.yml file</p><pre tabindex=0><code>service: serverless-demo-project

frameworkVersion: &#39;3&#39;

provider:
  name: aws
  runtime: python3.8


plugins:
  - serverless-python-requirements

#serverless python requirements: https://www.serverless.com/plugins/serverless-python-requirements
#use the code upto usestaticCache if you want to use external libraries in requirements.txt ; the code in layer tag can be used to push AWS lambda layer
custom:
  pythonRequirements:
    dockerizePip: true
    zip: true
    useDownloadCache: false
    useStaticCache: false

    layer: 
      name: python-pandas
      description: &#34;Layer which contains pandas library&#34;
      compatibleRuntimes:
        - python3.8

functions:
  hello:
    handler: handler.hello
  

package:
  patterns:
    - &#39;!**/*&#39;
    - &#39;*.py&#39;
    - &#39;pandas&#39;
</code></pre><p>Deploy serverless:</p><pre tabindex=0><code>sls deploy
</code></pre><p>you can go the AWS lambda console to test the function or invoke function from console:</p><pre tabindex=0><code>sls invoke -f &#39;functioname&#39; --log
sls invoke -f hello --log
</code></pre><p>If you want to reuse the layer created after deploying this function, you can remove the custom code block and add layer arn to serverless.yml</p><pre tabindex=0><code>provider:
  name: aws
  runtime: python3.8
  layers:
        - arn:aws:lambda:region:************:layer:python-pandas:1
        
</code></pre><p>To remove sls stack:</p><pre tabindex=0><code>sls remove
</code></pre><h3 id=link-to-github-page-codehttpsgithubcomshikshya1aws-serverlesstreemainserverless-lambda-layer>Link to github page: <a href=https://github.com/shikshya1/aws-serverless/tree/main/serverless-lambda-layer>Code</a></h3><ul class=pa0><li class="list di"><a href=/tags/serverless class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Serverless</a></li><li class="list di"><a href=/tags/aws-lambda class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS Lambda</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3"></a><div><div class=ananke-socials><a href=https://github.com/shikshya1 target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>